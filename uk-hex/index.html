<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
        <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <style>

  .area{
      fill: #C0C0C0;
      stroke: none;
  }

  .boundary {
      fill: none;
      /*stroke: #777;*/
  }

  .selected {
      fill: #fff;
      stroke: #777;
      stroke-dasharray: 2,2;
      stroke-linejoin: round;
  }

  </style>

  <body>
    <svg width="500" height="500"></svg>

    <section id="data_table">
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>

    <script>

    var width;
    var height;

    // variables to draw map
    var projection, svg, path, g;
    var boundaries, population;

    svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var colour = d3.scale.linear();

    // init map
    init(width, height);

    // remove any data when we lose selection of a map unit
    function deselect() {
        d3.selectAll(".selected")
            .attr("class", "area");
        d3.select("#data_table")
            .html("");
    }

    function init(width, height) {

        // pretty boring projection
        projection = d3.geo.albers()
            .rotate([0, 0]);

        path = d3.geo.path()
            .projection(projection);

        // graphics go here
        g = svg.append("g");

        // add a white rectangle as background to enable us to deselect a map selection
        g.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", width)
            .attr("height", height)
            .style("fill", "#fff")
            .on('click', deselect);
    }

    // create a HTML table to display any properties about the selected item
    function create_table(properties) {
        var keys = Object.keys(properties);

        table_string = "<table>";
        table_string += "<th>Property</th><th>Value</th>";
        for (var i = 0; i < keys.length; i++) {
            table_string += "<tr><td>" + keys[i] + "</td><td>" + properties[keys[i]] + "</td></tr>";
        }
        table_string += "</table>";
        return table_string;
    }

    // select a map area
    function select(d) {
        // get the id of the selected map area
        var id = "#" + d.id;
        // remove the selected class from any other selected areas
        d3.selectAll(".selected")
            .attr("class", "area");
        // and add it to this area
        d3.select(id)
            .attr("class", "selected area")
        // add the area properties to the data_table section
        d3.select("#data_table")
            .html(create_table(d.properties));
    }

    // draw our map on the SVG element
    function draw(boundaries) {

        projection
            .scale(1)
            .translate([0,0]);

        // compute the correct bounds and scaling from the topoJSON
        var b = path.bounds(topojson.feature(boundaries, boundaries.objects["hexagons"]));
        var s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height);
        var t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

        projection
            .scale(s)
            .translate(t);

        // add an area for each feature in the topoJSON
        g.selectAll(".area")
            .data(topojson.feature(boundaries, boundaries.objects["hexagons"]).features)
            .enter().append("path")
            .attr("class", "area")
            .attr("id", function(d) {
              // console.log(d);
              return d.properties.constituency;
            })
            // .attr("properties_table", function(d) { return create_table(d.properties)})
            .attr("d", path);
            // .on("click", function(d){ return select(d)});

        // add a boundary between areas
        g.append("path")
            .datum(topojson.mesh(boundaries, boundaries.objects["hexagons"], function(a, b){ return a !== b }))
            .attr('d', path)
            .attr('class', 'boundary');
    }

    // colours map with party colour
    function colour_map() {
        var areas = d3.selectAll(".area");
        areas.style("fill", function(d) {
          return get_colour(d.properties.constituency);
        });
    }

    // gets party colour from id
    function get_colour(id) {
      var pc = population[id].population;
      return colour(pc);
    }

    // strip whitespace from string
    function strip_whitespace(string) {
      return string.replace(/[^a-zA-Z]/g, '');
    }

    // called to redraw the map - removes map completely and starts from scratch
    function redraw() {
        init(width, height);
        draw(boundaries);
        colour_map();
    }

    // loads data from the given file and redraws the map
    function load_data(map_filename, population_filename) {
        // clear any selection
        deselect();

        var map = map_filename;
        var pop = population_filename;

        d3.json(map, function(error, b) {
            d3.json(pop, function(error, p) {
              if (error) return console.error(error);

              var min = 9999999;
              var max = 0;

              for (var key in p) {
                if (p[key].population < min) {
                  min = p[key].population;
                }
                if (p[key].population > max) {
                  max = p[key].population;
                }
              }

              colour.domain([min, max])
                .range(["#ffffd9", "#081d58"]);

              boundaries = b;
              population = p;
              redraw();

              loadResults();
            });
        });
    }

    load_data("https://raw.githubusercontent.com/tlfrd/viz-collection/master/uk-hex/json/uk-hex.json", "https://raw.githubusercontent.com/tlfrd/viz-collection/master/uk-hex/json/population_ons.json");

    </script>
  </body>
</html>
