<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
        <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <style>


  #map {
    width: 600px;
  }

  .area{
      fill: #C0C0C0;
      stroke: none;
  }

  .boundary {
      fill: none;
      stroke: #777;
  }

  .selected {
      fill: #fff;
      stroke: #777;
      stroke-dasharray: 2,2;
      stroke-linejoin: round;
  }


  .Conservative {
    fill: #0087DC;
  }
  .GreenParty {
    fill: #6AB023;
  }
  .Independent {
    fill: #996699;
  }
  .Labour {
    fill: #DC241f;
  }
  .LabourCooperative {
    fill: #CC0000;
  }
  .LiberalDemocrat {
    fill: #FDBB30;
  }
  .PlaidCymru {
    fill: #008142;
  }
  .ScottishNationalParty {
    fill: #FFFF00;
  }
  .Speaker {
    fill: #ffffff;
  }
  .UKIndependenceParty {
    fill: #70147A;
  }
  .DemocraticUnionistParty {
    fill: #D46A4C;
  }
  .SinnFin {
    fill: #008800;
  }
  .SocialDemocraticLabourParty {
    fill: #99FF66;
  }
  .UlsterUnionistParty {
    fill: #9999FF;
  }

  </style>

  <body>
    <div id="map"></div>

    <section id="data_table">
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>

    <script>

    var width = 600
    var height = 800;

    // variables to draw map
    var projection, svg, path, g;
    var boundaries, members;

    // init map
    init(width, height);

    // remove any data when we lose selection of a map unit
    function deselect() {
        d3.selectAll(".selected")
            .attr("class", "area");
        d3.select("#data_table")
            .html("");
    }

    function init(width, height) {

        // pretty boring projection
        projection = d3.geo.albers()
            .rotate([0, 0]);

        path = d3.geo.path()
            .projection(projection);

        // create the svg element for drawing onto
        svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        // graphics go here
        g = svg.append("g");

        // add a white rectangle as background to enable us to deselect a map selection
        g.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", width)
            .attr("height", height)
            .style("fill", "#fff")
            .on('click', deselect);
    }

    // create a HTML table to display any properties about the selected item
    function create_table(properties) {
        var keys = Object.keys(properties);

        table_string = "<table>";
        table_string += "<th>Property</th><th>Value</th>";
        for (var i = 0; i < keys.length; i++) {
            table_string += "<tr><td>" + keys[i] + "</td><td>" + properties[keys[i]] + "</td></tr>";
        }
        table_string += "</table>";
        return table_string;
    }

    // select a map area
    function select(d) {
        // get the id of the selected map area
        var id = "#" + d.id;
        // remove the selected class from any other selected areas
        d3.selectAll(".selected")
            .attr("class", "area");
        // and add it to this area
        d3.select(id)
            .attr("class", "selected area")
        // add the area properties to the data_table section
        d3.select("#data_table")
            .html(create_table(d.properties));
    }

    // draw our map on the SVG element
    function draw(boundaries) {

        projection
            .scale(1)
            .translate([0,0]);

        // compute the correct bounds and scaling from the topoJSON
        var b = path.bounds(topojson.feature(boundaries, boundaries.objects["hexagons"]));
        var s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height);
        var t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

        projection
            .scale(s)
            .translate(t);

        // add an area for each feature in the topoJSON
        g.selectAll(".area")
            .data(topojson.feature(boundaries, boundaries.objects["hexagons"]).features)
            .enter().append("path")
            .attr("class", "area")
            .attr("id", function(d) {
              // console.log(d);
              return d.properties.constituency;
            })
            .attr("properties_table", function(d) { return create_table(d.properties)})
            .attr("d", path)
            .on("click", function(d){ return select(d)});

        // add a boundary between areas
        g.append("path")
            .datum(topojson.mesh(boundaries, boundaries.objects["hexagons"], function(a, b){ return a !== b }))
            .attr('d', path)
            .attr('class', 'boundary');
    }

    // colours map with party colour
    function colour_map() {
        var areas = d3.selectAll(".area");
        areas.attr("class", function(d) {
          return get_colour_class(d.properties.constituency);
        });
    }

    // gets party colour from id
    function get_colour_class(id) {
      return strip_whitespace(members[id].party);
    }

    // strip whitespace from string
    function strip_whitespace(string) {
      return string.replace(/[^a-zA-Z]/g, '');
    }

    // called to redraw the map - removes map completely and starts from scratch
    function redraw() {

        d3.select("svg").remove();

        init(width, height);
        draw(boundaries);
        colour_map();
    }

    // loads data from the given file and redraws the map
    function load_data(map_filename, mps_filename) {
        // clear any selection
        deselect();

        var map = map_filename;
        var mps = mps_filename;

        d3.json(map, function(error, b) {
            d3.json(mps, function(error, m) {
              if (error) return console.error(error);
              boundaries = b;
              members = m;
              redraw();
            });
        });
    }

    load_data("json/uk-hex.json", "json/mps.json");

    </script>
  </body>
</html>
